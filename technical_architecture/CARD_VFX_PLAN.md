## 卡牌战斗特效研发计划（R&D Brief）

目的：为“2D 卡牌战斗”提供一套可扩展、可调参、性能稳健的特效体系；先满足 Early Access（EA）需求，再逐步升级为标准版本。

### 1. 基线与约束
- 运行时：Pygame（现有 UI/渲染），可选接入 ModernGL 做后处理（推荐）。
- 目标分辨率：1600x900/1280x720。
- 性能目标：战斗场景 60 FPS 稳定；合成阶段最多 3 层全屏叠加，局部特效优先。
- 工程集成：不侵入 Domain/Model；特效统一在 View 合成层接入（Filter/FX Manager）。

### 2. 优先级分层（P0→P1→P2）
- P0（EA 必备，2–3 周内完成）
  - 出牌反馈（高亮/下压/扫光）
  - 伤害/治疗/格挡数值跳变
  - 受击闪白/轻屏震
  - 能量增减/卡堆操作（抽/弃/移出）动画
  - Buff/Debuff 上/下身（简洁光圈/烟雾）
  - 全局轻滤镜（低强度晕影/轻色调）
- P1（标准版优先，1–1.5 个月）
  - AOE 变体、元素系（火/冰/雷/毒）命中/DoT
  - 简易 Bloom、色差、色调映射（ModernGL）
  - Boss 招式演出（蓄力-释放-余波）
  - 等高线“油墨花纹”风格化（限定在卡面/场景）
  - 卡牌伪 3D（倾斜、翻转）
- P2（高打磨/可选）
  - 粒子细化、材质响应（屏幕空间水波/扭曲）
  - 多层合成与动态光照感（ModernGL 后处理链）

### 3. 可实现的特效清单与技术手段
（每项含：目的 → 技术手段 → 成本/性能 → 备注）

1) 出牌反馈（高亮/下压/扫光）
- 目的：出牌时的视觉确认与稀有卡强化感。
- 手段：
  - Pygame：卡面局部渐变条按加色（BLEND_ADD）横向/斜向扫动；缩放/偏移；阴影椭圆（BLEND_ALPHA）。
  - ModernGL：统一在后处理 pass 中做高光条/遮罩调制。
- 成本：0.5 人天；性能极轻。

2) 数值跳变（伤害/治疗/格挡）
- 手段：文本弹出 + 缓动（easeOutBack），阴影描边，短暂色相变化。
- 成本：0.5 人天；轻。

3) 受击闪白/轻屏震
- 手段：全屏白幕 alpha 0→A→0；摄像机位移 Perlin 噪声 8–12 帧。
- 成本：0.5 人天；轻。

4) 卡堆操作（抽/弃/移出/燃烧）
- 手段：位置插值、缩放、透明度；“燃烧/撕裂”可用遮罩乘法或分段裁剪（已验证）。
- 成本：1 人天；中。

5) Buff/Debuff 上/下身
- 手段：环状光圈、漂浮图标、少量粒子（或带 alpha 的贴图动画）。
- 成本：1 人天；轻-中。

6) 全局滤镜（风格化基调）
- 手段：
  - Pygame：晕影/颗粒/扫描线/色调（预生成覆盖层叠加）。
  - ModernGL：Bloom/色差/LUT/色调映射可在一个 pass 中实现。
- 成本：Pygame 1–2 人天；ModernGL 接入 1–3 人天。

7) AOE/元素系命中与 DoT（P1）
- 手段：多张贴图序列动画 + 加色叠加；或 ModernGL 粒子。
- 成本：每系 1–2 人天；中。

8) 等高线“油墨花纹”（P1）
- 目的：纸墨风格、反色花纹质感。
- 手段：
  - Pygame：两组不同角度的条纹覆盖后与卡面/背景做 Multiply，限定在遮罩内（避免全屏变暗）。
  - ModernGL：程序纹理/噪声生成 + 混合。
- 成本：1 人天；注意限定作用范围（卡面/层级）。

9) 卡牌伪 3D 倾斜/翻转（P1）
- 手段：按行剪切 + 透视压缩（已验证）；或顶点变换（ModernGL 四边形）。
- 成本：1–2 人天；中。

10) 高级后处理链（P2）
- 手段：ModernGL pass 链（Bloom→色差→LUT→噪声/胶片划痕）。
- 成本：3–5 人天（搭建+参数化）。

### 4. 实施模式（工程化）
- Filter/FX Manager（View 层）：
  - 统一登记全屏滤镜（vignette/tint/bloom）与局部 FX（卡面/敌人）。
  - 参数可热更新（强度/颜色/时长），便于策划调参。
  - 开发阶段可注入调试 HUD，支持快捷键开关与录制。
- 资源与遮罩：
  - 卡面遮罩（alpha）用于限制特效只作用于卡片区域。
  - 粒子/贴图序列统一放 `assets/ui/effects/`，走 AssetManager。
- 性能：
  - 尽量复用预生成 Surface；参数变化再重建。
  - 全屏合成层 ≤ 3；大模糊采用下采样+放大技巧。

### 5. 研发原型任务（给预研同事）
1) ModernGL 后处理最小接入（P0→P1）
   - 目标：在 Pygame 窗口内渲染一个全屏 shader pass（色调映射 + 轻 Bloom）。
   - 成功标准：60 FPS；可调强度；与现有渲染合成无闪烁。
2) 卡面伪 3D 容器（P1）
   - 目标：对任意卡面 Surface 应用倾斜与轻透视；保锚点稳定。
   - 成功标准：无上移/变形；可设角度/透视；对齐 hitbox。
3) 等高线/油墨花纹（P1）
   - 目标：在卡面区域叠加双角度条纹（或程序噪声）形成花纹；
   - 成功标准：只影响卡面（遮罩限制），强度/间距可调，不致全屏发黑。

### 6. 集成里程碑（建议）
- Week 1：P0 套件（出牌反馈、数值跳变、受击、能量/卡堆动画、轻滤镜）完成 70% 功能 + 调参面板。
- Week 2：P0 收尾 + 小规模用户测试，修复、定色板；预研开始 P1 原型（ModernGL 接入 & 卡面伪 3D）。
- Week 3–4：P1 主线（AOE/元素、花纹、伪 3D）；把稳定特效整合到战斗视图。
- Post EA：按留存/用户反馈决定 P2 是否推进（Bloom 强化、色差、粒子细化）。

### 7. 验收标准（每个特效族）
- 功能：满足 UX 目的（清晰、反馈明确）。
- 可调：强度/颜色/时长/混合模式可配置。
- 性能：开启与关闭的 FPS 差 < 8%；在目标机 60 FPS。
- 集成：无覆盖错误、无锚点漂移；与其他特效叠加不出错。

### 8. 风险与备选
- 纯 Pygame 模糊/Bloom 成本偏高 → 采用缩放模糊或分区合成；必要时切换 ModernGL。
- 全屏 Multiply 导致整体发黑 → 必须使用遮罩限制作用域；或改用 Screen/Overlay 混合。
- 贴图序列占用内存 → 统一尺寸与帧率，做资源复用与压缩。

---
附注：当前演示黑屏现象多由“全屏 Multiply + 深色底”的组合导致。后续实现中一律使用“卡面遮罩 + 受控混合模式”，并默认限制作用范围在元素层，而非全屏。


