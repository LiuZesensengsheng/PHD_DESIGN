## 甘特图：任务与事件规范（Tasks vs Events）

目标：把“必须做的进度块”（任务）与“随机发生的叠加段子/微互动”（事件）解耦，既保证主线推进，也容纳黑色幽默内容而不打断节奏。

### 一、定义
- 任务（Task Block）
  - 必须处理，会消耗一个“事件轮”（进入一个战斗/遭遇/交互流程）。
  - 进度相关：影响路线进度、敌人数量、奖励、融合等。
  - 形态：战斗、遭遇、Boss、提交/审核等主流程节点。

- 事件（Event Bubble，气泡）
  - 随机触发，作为“气泡图标”锚定在“任务线头部的 Logo 区域”（而非叠加在具体块上）；点击后弹出文本。
  - 不进入战斗，不参与融合，不改变敌人数/奖励；当前阶段仅提供“风味/段子”，不附带数值效果（No Buff）。
  - 用途：黑色幽默段子、世界观填充、轻量信息流；不过度干扰主线节奏。

### 二、调度与寿命
- 生成：每回合从事件池抽取 0–1 条“气泡事件”，仅挂载到“当前目标任务线”的 Logo 区域。
  - 当前目标（Current Target）：指“今日（行动线）所在回合”可执行的下一主线任务所在的那条任务线；若无，则选取最近即将到来的主线任务所在的那条任务线。
  - 权重：ANY（全局）≈80%｜THEME（随当前主题偏置）≈20%。不再使用“相邻”概念，也不锚定到具体块。
  - 去重冷却：同一事件ID在 5 回合内不重复。
  - 降权：Boss/关键战时仅投“静默段子”或显著降权，避免出戏。
- 寿命（TTL）：默认存活 1–2 回合；未点击则过期并写入右侧“事件Feed/消息流”。
- 限制：同一任务线的 Logo 区域同时最多 1 个可见气泡；事件不参与融合/波次。

### 三、UI 表现
- 任务：常规甘特块；点击进入（消耗一轮）。
- 事件（气泡）：显示在该任务线头部 Logo 附近的小气泡图标（可轻微跳动/脉冲）；Hover 显示标题；点击弹窗文本（仅标题+正文）；过期则在侧边“事件Feed”记录。

### 四、与融合的关系（参见 GANTT_FUSION_RULES）
- 只有任务参与“数量融合+主题继承”。
- 事件（气泡）不改变敌人数/奖励/主题；融合后不迁移、也不派生新气泡。

### 五、数据口径（最小原型）
```yaml
# 任务节点
task:
  id: paper_submission_01
  theme: FINALS           # 或 LAB / ROLL_CALL / PAPER
  type: TASK
  enemy_count: 3          # 用于融合
  has_boss: false
  duration_turns: 1       # 进入即消耗一轮

# 事件节点（气泡，锚定到任务线Logo，不入融合，无数值效果）
event:
  id: meme_email_tpl_01
  theme: PAPER
  type: EVENT
  icon: bubble_envelope
  title: 模板拒稿：感谢您的宝贵工作
  body: 经过认真评审，我们认为您的研究非常有潜力，但不适合本刊。
  ttl_turns: 2
# 说明：当前阶段不提供 choices/effect；为“风味-only”
```

### 六、事件池（示例，黑色幽默口径）
- 已读不回（icon: bell）→ 段子文本+记录到Feed（无数值效果）
- 审稿人神评论（icon: comment）→ 段子文本+记录到Feed（无数值效果）
- Overleaf 合并冲突（icon: code-branch）→ 段子文本+记录到Feed（无数值效果）

### 七、实现提示（非强制）
- 抽象事件为“轻交互弹窗”，当前阶段“风味-only”，不修改路线图结构，不附带数值效果。
- 任务驱动主线；事件（气泡）驱动叙事密度与基调，不增加系统复杂度。
- 模式开关：纯段子 / 轻微效果 / 关闭；按需在设置中切换。

---

实现方案（无代码，落地步骤）
- 锚点与布局
  - 在渲染/布局层为每条任务线的头部 Logo 计算一个“气泡锚点矩形”（随缩放/布局自适应）。
  - 气泡以 UI 按钮或图像+透明按钮形式放置在该锚点之上，处于 `root_container` 层，确保可点。
- 调度与状态
  - 新增 `LineBubbleService`（或复用现有 `GossipService` 的子池），每回合在 `end_turn()` 后运行：
    1) 解析“当前目标任务线”（今日可执行的下一主线任务所在任务线；若无，取最近将至的任务线）。
    2) 若该任务线 Logo 处无气泡，按 ANY≈80% / THEME≈20% 抽取 0–1 条事件；应用 5 回合去重冷却。
    3) 生成气泡实例（UI+数据），设置 `ttl_turns`，进入可见列表。
  - 每回合衰减 TTL；TTL=0 自动移除，并将文本写入右侧“事件Feed”。
- 交互
  - Hover：显示标题 Tooltip（可选）。
  - Click：打开现有的“学术八卦弹窗”（阻塞输入，只有关闭可点），展示标题+正文；不展示选项，不产生数值效果。
  - 关闭后：移除该气泡实例；追加到“已读”存档；解除输入锁。
- 限制与降噪
  - 每条任务线同时最多 1 个气泡；Boss/关键战回合降低生成概率或只允许“静默段子”标签的条目。
  - 全局右上角“未读八卦”入口保持现状，作为补充的收件箱式入口（可选对齐：气泡被点击/过期后同时计入收件箱）。
- 可测性
  - 单测：仅当前目标任务线能生成气泡；TTL 归零会移除且写入 Feed；5 回合内不重复同 ID；Boss 回合降权有效。
  - UI/E2E：点击气泡只弹一次、弹窗阻塞输入、关闭后恢复；在不同分辨率下锚点点击正确。


