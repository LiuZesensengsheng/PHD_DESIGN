### Gantt TRIS UI 规范（Spec） v0.1

状态：草案（与实现对齐中）

#### 1. 时间与网格
- **时间单位**：1 回合 = 1 tick（10 天）。
- **网格**：顶端绘制时间格（按 9 月上旬/中旬/下旬 等标注），水平刻度与块宽度一致。
- **今天线（行动线）**：固定在网格左边缘，用于“视觉上停止”判定（渲染层 clamp）。

#### 1.1 时间刻度标签（两层）与对齐/滚动
- **两层标签**：
  - 第一层（上层，粗粒度）：月份分段（如：9月，10月，11月，12月，1月）。
  - 第二层（下层，细粒度）：回合刻度或“天数段”标签（上旬，中旬，下旬，上旬，中旬，下旬这样子轮回…）。
- **对齐规则**：
  - 两层标签的边界必须与网格竖线严格重合；标签宽度是整倍数的“块单位宽度（BLOCK_BASE_WIDTH_UNIT）”。
  - 第一层分段跨越若干个回合（N 个网格单元）；第二层每 1 回合一个小格（或每 M 回合一格，取决于常量）。
  - 标签文本的对齐基准为其覆盖区间的几何中心（水平居中）。
- **滚动规则**：
  - 随着回合推进（end_turn），两个层级标签与网格整体一起向左移动 1 个“块单位宽度”。
  - 当某段完全越过今天线左侧时，进行剔除；右侧按需要补充新段，保持可视范围填满。
  - 今天线始终固定在可视区域左边，标签与块一样受“投影/夹紧”影响仅体现在渲染层（逻辑不修改起点）。

实现要点（后续代码对齐）：
- 在 `constants/ui_constants.py` 中：
  - 定义月份层标签集合（如 `LABELS_9_MONTH = ("9月上旬","9月中旬","9月下旬")`）。
  - 定义细粒度层步长（如 `SMALL_TICK_PER_TURN = 1`，或 `TURNS_PER_SMALL_TICK = 1`）。
- 在 `CampaignView`：
  - 用 `s_block_base_width_unit` 作为单步像素基准，将当前回合 `current_turn` 投影为横向偏移量。
  - 重写 `_draw_time_grid_and_labels()`：按“当前回合偏移 + 可视宽度”动态计算需要绘制的两层区间与标签文本位置。
  - 标签绘制与网格竖线绘制从“行动线 x = s_action_line_x”开始向右填充，严格整格对齐。

#### 2. 视觉元素
- **背景**：去掉甘特底图，使用纯色/简洁底色，不干扰网格与块。
- **右侧图例**：移除（Legend 不再显示）。
- **状态栏**：顶部资源条保留（压力、灵感、创新、期刊、精力、腐化）。

#### 3. 块行为规则（已确认）
- **初始化间距**：同一轨道相邻块，起点至少在前一块 end 之后空 1 回合（start ≥ last_end + 1）。
- **下落后停止**：渲染层将块向左移动；当到达“今天线”后视觉停止（clamp），逻辑层不修改 start_turn。
- **融合**：按“投影区间”判断重叠（考虑移动与 clamp 后）；若严格重叠则融合为一个更长块（类型优先级：combat > event > rest）。

#### 4. 常量约束
- 文字与标签（如“9月上旬/中旬/下旬”）放入 `constants/` 专用常量模块，严禁魔法值。
- 网格刻度宽度与字体等比例参数通过常量管理。

---

### Spec vs Actual（当前实现对比）

- **时间与回合映射**：实现中 1 回合 = 1 单位，已符合。
- **今天线**：已实现（`CampaignView._draw_action_line`），由渲染层 clamp；符合。
- **初始化 1 回合间隔**：已实现（`_normalize_no_overlap()` 日志可见）；符合。
- **融合（投影后重叠）**：已实现（`_resolve_fusion_and_stabilize()` + `_project_interval()` 日志可见）；符合。
- **背景去除**：未实现（当前仍加载 `gantt_background_image`）；需调整。
- **右侧图例移除**：未实现（仍创建 Legend UI）；需移除/可配置隐藏。
- **顶端时间格与标签**：已初步实现网格与标签，但当前为“三等分”示意；
  - 需改为严格以 `BLOCK_BASE_WIDTH_UNIT` 为单位的两层标签与竖线，绑定 `current_turn` 左移滚动。
  - 需引入月份层与细粒度层常量，替换示意逻辑。

---

### 对齐计划（实现任务）
1) 在 `constants/ui_constants.py` 或新模块中添加：
   - 月份/旬标签常量（示例：`MONTH_9_LABELS = ["9月上旬","9月中旬","9月下旬"]`）。
   - 网格刻度宽度、线条颜色、字体缩放。
2) `CampaignView`：
   - 新增 `_draw_time_grid_and_labels()`；移除背景图使用或加开关禁用。
   - 默认隐藏 Legend（保留开关），或完全删除创建代码。
3) 测试：
   - 无头测试验证：不创建 Legend 元素；不加载背景图；绘制网格时 label 常量存在。

版本记录：
- v0.1：初稿，基于实现现状补齐 Spec 与差距清单。


#### 顶栏（状态栏）
- **布局与内容（Spec）**：
  - 左至右依次为资源与状态：压力、灵感、创新点（有3个槽位）、  游玩时间（我希望是从开始新游戏这一刻开始算）、  论文（卡组）。
  - 右侧显示“已游玩时间”（建议：基于 `current_turn` 或累计时长的格式化显示）。
  - “卡组管理”按钮位于时间显示右侧，用于进入卡组界面（先占位）。
- **实现（Actual）**：
  - 已实现顶部状态栏，显示 6 项资源图标与数值（来源：`StatusBarUI.RESOURCES`）。
  - “已游玩时间”与“卡组管理”按钮：当前未实现。
  - “End Turn（摸鱼）”按钮在左下角；卡牌选择切换按钮在底部中间（用于演示），二者不属于顶栏。
- **对齐与尺寸**：
  - 顶栏宽度=屏幕宽；图标尺寸、间距、文本偏移由 `StatusBarUI` 常量控制。
  - 文案由常量管理，严禁魔法值。
- **配置建议（下一步）**：
  - 在常量中新增开关：`SHOW_ELAPSED_TIME`、`SHOW_DECK_BUTTON`，并在 `CampaignView` 中按开关创建对应 UI。
  - “已游玩时间”默认以回合数显示（例如：T=13），后续可扩展为真实时钟格式。


#### 卡组状态
目标：任何场景均可进入的卡组检视界面（不打断战斗/战役流程）。

- 入口与关闭
  - 入口：顶栏最右侧“论文（卡组）”图标（与左侧图标等尺寸）。
  - 关闭：左下角返回按钮或按 Esc 返回上一状态。
  - 展示形式：作为独立 `DECK` 状态（全屏 UI）或覆盖式半透明层（两者对外行为一致）。

- 背景与层级
  - 全屏半透明黑色背景层（alpha≈128），覆盖在当前场景之上。
  - 顶部保留卡组标题与两枚排序按钮；中间为卡片网格列表；底部预留扩展区域。

- 数据来源（Actual → Spec 对齐）
  - 数据蓝图：`contexts/combat/infrastructure/json_card_repository.py` 加载 `CardData`。
  - 初始牌组：用 `STARTER_DECK_CARD_IDS` 从仓库映射为 `CardData` 列表。
  - 未来（Spec）：引入 `DeckDTO`（持久化于存档），并在进入战斗时用 `DeckDTO` 生成初始牌堆。
  - 本界面显示“编组卡组”（library），不展示战斗中临时堆（手牌/弃牌/放逐）。

- 布局（网格与滚动）
  - 卡片以等宽网格排列，支持垂直滚动；卡片单元显示：名称、费用、类型（Attack/Skill/Power 等），以及简要描述。
  - 文本与颜色、字号走常量；严禁魔法值（放入 `constants/`）。

- 排序与筛选
  - 顶部两枚按钮：
    - 按费用排序：升序；二级排序为类型、再到名称。
    - 按类型排序：按 `CardType` 枚举顺序分组（默认：ATTACK → SKILL → POWER），组内次序按费用、再到名称。
  - 后续可扩展筛选（稀有度、是否可升级、是否先天等）。

- 交互
  - 点击卡片：弹出卡片详情（放大视图 + 完整描述）；再次点击或 Esc 关闭详情。
  - 点击论文图标（顶栏右侧）：进入 `DECK`；返回按钮或 Esc：回到 `CAMPAIGN`。
  - 运行时不修改战斗牌堆；仅检视。

- 性能与实现提示
  - 大卡组时采用简单虚拟化（仅渲染可视区域及其上下缓冲）。
  - 卡面渲染与文字布局用缓存（图片缩放缓存、文本 Surface 缓存）。

- 常量与配置
  - `constants/ui_constants.py`：排序缺省、网格间距、标题与按钮文案、半透明遮罩 alpha 等。
  - 资源路径（卡组图标）统一在 `StatusBarUI` 中管理。

---

### 卡组状态 (Deck State) UI实现细节

#### 卡组状态渲染问题分析 (Deck State Rendering Issue Analysis)

- **问题现象**: 在进入Deck State后，卡牌UI会短暂地“闪现”一帧，然后消失，只剩下背景和按钮。
- **根本原因**: 这是`pygame`直接渲染与`pygame_gui`UI系统渲染时序冲突的典型问题。当前代码在`DeckState.draw()`方法中直接将卡牌绘制到主屏幕`self.screen`上。然而，在这之后，主循环会调用`manager.draw_ui()`，这个方法会重新绘制`pygame_gui`的所有UI元素。其中，作为卡牌容器的`_grid_panel`（一个`UIPanel`）会用它自己的背景色重新填充它的区域，从而覆盖掉我们之前直接画在屏幕上的所有卡牌。
- **解决方案**: 必须将自定义绘制逻辑正确地集成到`pygame_gui`的框架内。我们不应该直接绘制到主屏幕，而应该在`DeckState.update()`方法中，将所有卡牌绘制到`_grid_panel.image`这个子图层上。这样，当`manager.draw_ui()`执行时，`_grid_panel`会带着已经绘制好卡牌的`image`图层一起被正确地渲染出来，保证了正确的渲染顺序和层级关系。同时，所有卡牌的坐标计算也必须从屏幕绝对坐标改为相对于`_grid_panel`的相对坐标。

#### 卡组滚动与交互 (TODO)
- **滚动实现**: 当卡牌数量超过一页时，需要支持鼠标滚轮上下滚动。
- **卡牌交互**: 鼠标悬停在卡牌上时，应有放大或高亮效果，并显示卡牌的详细信息。

